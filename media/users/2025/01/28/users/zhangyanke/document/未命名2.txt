from google.cloud import storage
import streamlit as st
from datetime import datetime

def delete_blob(blob):
     blob.delete()
    
st.set_page_config(layout="wide")

client = storage.Client.from_service_account_json(
    "/home/k024c1031/work/project-cloudservice-k024c1031-79a4f652c4ee.json")

bucket_name = "bucket-yanke-20241121"
bucket = client.bucket(bucket_name=bucket_name)

st.title("Mystagram")

uploaded_file = st.file_uploader(
    "画像ファイルをアップロード",type=[".jpg",".jpeg",".png"])

if uploaded_file:
    now = datetime.now()
    timestamp = now.strftime("%Y%m%d_%H%M%S")
    filename = uploaded_file.name
    blob = bucket.blob(f"images/{timestamp}_{filename}")
    blob.upload_from_file(uploaded_file)
    st.image(uploaded_file,caption="アップロードした画像")

st.write("### ファイル一覧")
list_images_blobs = []
for blob in bucket.list_blobs(prefix="images/", delimiter="/"):
    name = blob.name
    stem = name.split(".")[-1]
    if stem in ["jpg", "jpeg", "png"]:
        list_images_blobs.append(blob)

#st.set_page_config(layout="wide") 
columus = st.columns(3)
col_idx = 0
for blob in list_images_blobs:
        img = blob.download_as_bytes()
        with columus[col_idx] as col:
            tile = st.container(height=360,)
            tile.image(img, caption=name, width=320)
            tile.button
        col_idx += 1
        if col_idx >= 3:
            col_idx = 0
        